declare name        "HOA Azimuth Rotator";
declare version     "1.0";
declare author      "Pierre Lecomte";
declare license     "GPL";
declare copyright   "(c) Pierre Lecomte 2015";

// Description: This tool rotates the HOA scene around the z-axis. Driven with OSC from head-tracking, this tool can compensate the head rotation when the rendering is made over headphones. See [1] for the matrix definition.

// References: 
// [1] S. Moreau, “Étude et réalisation d’outils avancés d'encodage spatial pour la technique de spatialisation sonore Higher Order Ambisonics: microphone 3D et contrôle de distance,” Université du Maine, Le Mans, France, 2006.

// Inputs: (M+1)^2
// Outputs: (M+1)^2

import("math.lib");
import("music.lib");
import("lib/ymn.lib");

M=5; // Maximum order of original HOA scene

t=hslider("Azimuth[osc:/1/theta 0 360]", 0, 0, 360, 0.1)*PI/180; // Slider with azimuth rotation angle

a(0)=(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);

a(1)=(0, cos(t), 0, sin(t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(2)=(0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(3)=(0, -1*sin(t), 0, cos(t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);

a(4)=(0, 0, 0, 0, cos(2*t), 0, 0, 0, sin(2*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(5)=(0, 0, 0, 0, 0, cos(t), 0, sin(t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(6)=(0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
a(7)=(0, 0, 0, 0, 0, -1*sin(t), 0, cos(t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(8)=(0, 0, 0, 0, sin(2*t), 0, 0, 0, cos(2*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);

a(9)=(0, 0, 0, 0, 0, 0, 0, 0, 0, cos(3*t), 0, 0, 0, 0, 0, sin(3*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
a(10)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(2*t), 0, 0, 0, sin(2*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
a(11)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(t), 0, sin(t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(12)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(13)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(t), 0, cos(t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(14)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(2*t), 0, 0, 0, cos(2*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(15)=(0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(3*t), 0, 0, 0, 0, 0, cos(3*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);

a(16)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(4*t), 0, 0, 0, 0, 0, 0, 0, sin(4*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(17)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(3*t), 0, 0, 0, 0, 0, sin(3*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
a(18)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(2*t), 0, 0, 0, sin(2*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
a(19)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(t), 0, sin(t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 
a(20)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
a(21)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(t), 0, cos(t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
a(22)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(2*t), 0, 0, 0, cos(2*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
a(23)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(3*t), 0, 0, 0, 0, 0, cos(3*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
a(24)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(4*t), 0, 0, 0, 0, 0, 0, 0, cos(4*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0); 

a(25)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(5*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, sin(5*t));
a(26)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(4*t), 0, 0, 0, 0, 0, 0, 0, sin(4*t), 0);
a(27)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(3*t), 0, 0, 0, 0, 0, sin(3*t), 0, 0);
a(28)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(2*t), 0, 0, 0, sin(2*t), 0, 0, 0);
a(29)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(t), 0, sin(t), 0, 0, 0, 0);
a(30)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0);
a(31)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(t), 0, cos(t), 0, 0, 0, 0);
a(32)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(2*t), 0, 0, 0, cos(2*t), 0, 0, 0);
a(33)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(3*t), 0, 0, 0, 0, 0, cos(3*t), 0, 0);
a(34)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(4*t), 0, 0, 0, 0, 0, 0, 0, cos(4*t), 0);
a(35)=(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1*sin(5*t), 0, 0, 0, 0, 0, 0, 0, 0, 0, cos(5*t));

// Matrix multiplication
// n = number of inputs
// m = number of outputs
matrix(n,m) = par(i,n,_) <: par(i,m,buswg(a(i)):>_);

process = matrix((M+1)^2,(M+1)^2);